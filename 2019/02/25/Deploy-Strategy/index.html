<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><title>Deploy Strategy | Amyy Lewis</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="[object Object]"><meta name="designer" content="minfive"><meta name="keywords" content="life tech"><meta name="description" content="Fledgling Developer | Backpacker | Doing all I can to be a better girl."><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="http://amylewis.github.io/2019/02/25/Deploy-Strategy/index.html"><link rel="icon" type="image/png" href="http://oo12ugek5.bkt.clouddn.com/blog/images/favicon.ico" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="AmyLewis" type="application/atom+xml"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-66043212-2"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-66043212-2")</script><link rel="stylesheet" href="/scss/views/page/post.css"><meta name="generator" content="Hexo 6.3.0"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(https://user-images.githubusercontent.com/3325198/52893052-6d1d2d80-31d3-11e9-91c2-736385c3278a.gif)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="AmyLewis" alt="AmyLewis"><img src="https://user-images.githubusercontent.com/3325198/52892707-fc284680-31cf-11e9-932d-e3cde3ef02f3.png" alt="AmyLewis"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/about" alt="关于" title="关于">关于</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="https://user-images.githubusercontent.com/3325198/53393578-b6415e80-39d7-11e9-8e15-776c2918c9b2.jpg" alt="Deploy Strategy"></div><header class="post__info"><h1 class="post__title">Deploy Strategy</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a target="_blank" rel="noopener" href="https://www.github.com/amylewis">amy</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2019-02-25</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/tech/">Tech</a></li></ul></div></div></header><div class="post__content"><p><strong>Table of content:</strong></p><div class="toc"><ul><li><a href="#about">About</a></li><li><a href="#bu-shu-mo-shi">部署模式</a><ul><li><a href="#da-bao-zha">大爆炸</a></li><li><a href="#chi-xu-ji-cheng-chi-xu-jiao-fu-chi-xu-bu-shu">持续集成，持续交付，持续部署</a></li></ul></li><li><a href="#chang-jian-de-bu-shu-ce-lue">常见的部署策略</a><ul><li><a href="#rolling-upgrade">Rolling Upgrade</a></li><li><a href="#blue-green-deployment">Blue&#x2F;Green Deployment</a></li><li><a href="#canary-deployment">Canary Deployment</a></li><li><a href="#reckless-deployment">Reckless Deployment</a></li></ul></li><li><a href="#qi-ta-fa-bu-fang-shi">其他发布方式</a><ul><li><a href="#gong-neng-kai-guan">功能开关</a></li><li><a href="#a-b-ce-shi">A&#x2F;B 测试</a></li><li><a href="#liu-liang-fu-zhi">流量复制</a></li></ul></li><li><a href="#ye-nei-de-fang-an-chi-xu-geng-xin">业内的方案 (持续更新)</a><ul><li><a href="#netflix-jin-si-que">Netflix 金丝雀</a></li></ul></li><li><a href="#reference">Reference</a></li><li><a href="#guan-yu-tou-tu">关于头图</a></li></ul></div><h2><span id="about">About</span><a href="#about" class="header-anchor"></a></h2><p>因为工作的一部分是提供 CI， CD，PaaS 平台，所以这篇文章主要是做一些部署策略的归类和分析总结，同时对业其他公司的方案进行调研。</p><h2><span id="bu-shu-mo-shi">部署模式</span><a href="#bu-shu-mo-shi" class="header-anchor"></a></h2><h3><span id="da-bao-zha">大爆炸</span><a href="#da-bao-zha" class="header-anchor"></a></h3><p>「大爆炸」部署一次性更新整个应用或者其中的大部分, 要求企业在发布之前进行广泛的开发和测试，通常和大型有序发布的「瀑布模型」有关。</p><p>大爆炸部署的特点包括：</p><p>所有的主要部件都打包在一个部署中；</p><ul><li>用新的软件版本整个替换现有的版本，或者替换大部分；</li><li>部署通常会导致长时间的开发和测试周期；</li><li>假定失败的可能性很小，因为回滚是不可能和不现实的；</li><li>完成时间通常需要很久，需要多个团队的共同努力；</li><li>需要客户采取措施来更新客户端安装。</li></ul><h3><span id="chi-xu-ji-cheng-chi-xu-jiao-fu-chi-xu-bu-shu">持续集成，持续交付，持续部署</span><a href="#chi-xu-ji-cheng-chi-xu-jiao-fu-chi-xu-bu-shu" class="header-anchor"></a></h3><p>使用更敏捷的方式进行变更，比如持续集成，持续部署。更小而快的方式进行迭代, 提前发现问题。</p><ul><li>持续集成强调开发人员提交了新代码之后，立刻进行构建、（单元）测试。根据测试结果，确定新代码和原有代码能否正确地集成在一起。</li><li>持续交付在持续集成的基础上，将集成后的代码部署到更贴近真实运行环境的「类生产环境」（production-like environments）中。比如，我们完成单元测试后，可以把代码部署到连接数据库的 Staging 环境中更多的测试。如果代码没有问题，可以继续手动部署到生产环境中。</li><li>持续部署则是在持续交付的基础上，把部署到生产环境的过程自动化。</li></ul><p><img src="https://3lsqjy1sj7i027fcn749gutj-wpengine.netdna-ssl.com/wp-content/uploads/2015/12/409-images-for-snap-blog-postedit_image4-manual.png"></p><p>Ref:</p><ul><li><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/23444990">https://www.zhihu.com/question/23444990</a></li><li>图片来自 <a target="_blank" rel="noopener" href="https://www.mindtheproduct.com/2016/02/what-the-hell-are-ci-cd-and-devops-a-cheatsheet-for-the-rest-of-us/">https://www.mindtheproduct.com/2016/02/what-the-hell-are-ci-cd-and-devops-a-cheatsheet-for-the-rest-of-us/</a></li></ul><h2><span id="chang-jian-de-bu-shu-ce-lue">常见的部署策略</span><a href="#chang-jian-de-bu-shu-ce-lue" class="header-anchor"></a></h2><table><thead><tr><th>部署策略</th><th>描述</th><th>优势</th><th>劣势</th><th>适用场景</th></tr></thead><tbody><tr><td>Rolling upgrade</td><td>滚动部署, 每次发布时，先将老版本 V1 流量从 Load Balance 上摘除，然后清除老版本，发新版本 V2，再将 Load Balance 流量接入新版本。</td><td>用户体验影响小，体验较平滑, 相对蓝绿发布节省机器或者容器资源</td><td>发布和回退时间比较缓慢</td><td>适用于资源比较紧张，对速度没有太大要求，但是服务又不能中断的部署场景</td></tr><tr><td>Blue&#x2F;Green Deployment</td><td>不能中断的业务场景</td><td>升级切换和回退速度非常快</td><td>需要两倍的资源</td><td>机器资源有富余或者可以按需分配</td></tr><tr><td>Canary Deployment</td><td>金丝雀发布, 先发布小流量作为验证</td><td>出现问题影响的比例较小</td><td>这样的发布会耗费一定的时间</td><td>正式发布之前的验证</td></tr><tr><td>Reckless Deployment</td><td>先将老版本 V1 全部下掉，再将新版本发到机器上去。这种方式会引入服务中断</td><td>简单成本低</td><td>服务中断用户受影响，出了问题回滚也慢</td><td>测试环境或者一些不重要的服务</td></tr></tbody></table><h3><span id="rolling-upgrade">Rolling Upgrade</span><a href="#rolling-upgrade" class="header-anchor"></a></h3><p><img src="https://static001.infoq.cn/resource/image/0b/e2/0b12bf01bb94837761152d7076de13e2.png"><br>滚动部署，逐渐用新版本替换旧版本, 最大限度的降低相关风险，包括面向用户的停机时间。<br>在此期间，新旧版本会共存，而不会影响功能和用户体验。这个过程可以更轻易的回滚和旧组件不兼容的任何新组件。</p><p>每次发布时，先将老版本 V1 流量从 LB 上摘除，然后清除老版本，发新版本 V2，再将 LB 流量接入新版本。</p><h3><span id="blue-x2f-green-deployment">Blue&#x2F;Green Deployment</span><a href="#blue-x2f-green-deployment" class="header-anchor"></a></h3><p><img src="https://static001.infoq.cn/resource/image/e8/cc/e89e4df2a1a5e75d843264fb524252cc.png"></p><p>蓝绿部署，也就是会同时存在两个版本，如果绿色版本激活后发现了问题，则将流量路由回到蓝色版本中。<br>蓝绿部署依赖流量路由。这可以通过更新主机的 DNS CNAMES 来完成, 也可以通过 HAProxy。</p><p>老版本通常会保留一定时间用作快速回滚。</p><h3><span id="canary-deployment">Canary Deployment</span><a href="#canary-deployment" class="header-anchor"></a></h3><p><img src="https://static001.infoq.cn/resource/image/78/7e/78642c8dd77bf1c3b88d2bb27d66797e.png"></p><p>金丝雀部署的主要挑战是设计一种路由部分用户到新应用的方法。</p><p>探索一些技术，来考虑路由新用户的方法：</p><ul><li>在允许外部用户访问之前，将内部用户暴露给金丝雀部署；</li><li>基于源 IP 范围、特定地理区域发布应用，或者直接按照一定比例随机</li></ul><p>在实践过程中发现，要做好金丝雀有以下的经验总结：</p><ul><li>用不同的金丝雀的规模来达到不同的效果，比如小金丝雀用来验证是否有 typo，key error 以及其他错误，大金丝雀用来验证性能以及一些不明显的问题</li><li>提供清晰的金丝雀报表，让金丝雀等待的时间更有价值，同时让金丝雀期间发现的问题重复被发现</li><li>增加核心的指标，让金丝雀期间的表现更全面分析，同时提供自动回滚的机制，减少人工参与。</li></ul><h3><span id="reckless-deployment">Reckless Deployment</span><a href="#reckless-deployment" class="header-anchor"></a></h3><p>简单粗暴，先杀后起，不管杀掉之后后果是什么。会带来服务的中断，通常用在测试环境或者是不是很重要的应用上。</p><h2><span id="qi-ta-fa-bu-fang-shi">其他发布方式</span><a href="#qi-ta-fa-bu-fang-shi" class="header-anchor"></a></h2><h3><span id="gong-neng-kai-guan">功能开关</span><a href="#gong-neng-kai-guan" class="header-anchor"></a></h3><p>利用代码中的功能开关（Feature Flag&#x2F;Toggle&#x2F;Switch）来控制发布逻辑，一般不需要复杂的发布工具和智能 Load Balance 配合，是一种相对比较低成本和简单的发布方式。</p><p>优势是切换比较灵活可控，切换成本也比较低。但是对代码有侵入，需要定期清理老的逻辑，代码维护成本大。适用于一些需要灰度新功能，或者针对部分用户开发的功能。</p><h3><span id="a-x2f-b-ce-shi">A&#x2F;B 测试</span><a href="#a-x2f-b-ce-shi" class="header-anchor"></a></h3><p>和功能开关很相似，但是通常会是两组或多组方案上线，对比。通常需要一个专门的 A&#x2F;B 测试的管理平台。</p><h3><span id="liu-liang-fu-zhi">流量复制</span><a href="#liu-liang-fu-zhi" class="header-anchor"></a></h3><p>对于一些涉及核心业务的遗留系统的升级改造，为了确保万无一失，有一种称为影子测试的大招，采用比较复杂的流量复制、回放和比对技术实现</p><p>影子测试因为旁路在独立测试环境中进行，可以对生产流量完全无影响, 实施的成本也比较高。适用于一些核心的组件升级。</p><p>比如一些开源的方案：</p><ul><li><a target="_blank" rel="noopener" href="https://github.com/buger/goreplays">https://github.com/buger/goreplays</a></li></ul><h2><span id="ye-nei-de-fang-an-chi-xu-geng-xin">业内的方案 (持续更新)</span><a href="#ye-nei-de-fang-an-chi-xu-geng-xin" class="header-anchor"></a></h2><h3><span id="netflix-jin-si-que">Netflix 金丝雀</span><a href="#netflix-jin-si-que" class="header-anchor"></a></h3><p>Netflix 开源了一个自动的金丝雀分析工具, 叫 <a target="_blank" rel="noopener" href="https://github.com/spinnaker/kayent">kayenta</a>,</p><p><img src="https://res.infoq.com/news/2018/04/kayenta/en/resources/1netflix%20kayenta-1523471586210.jpg"></p><p>kayent 会根据一些关键的指标来判断金丝雀的版本是否通过，如果不能就将金丝雀自动回滚。如上图，接受生产流量的会有三个集群：</p><ul><li>production cluster，当前的生产环境的版本，instance 数量比较多且由用户配置</li><li>canary cluster, 金丝雀的版本，通常是新的代码或者配置改动，通常也只有三个 instances</li><li>baseline cluster, 和生产环境是一个版本，只有三个 instances。（用来作 canary cluster 的对照组）</li></ul><p>部署系统 <a target="_blank" rel="noopener" href="https://www.spinnaker.io/">Spinnaker</a> 会来决定当前金丝雀是否满足标准以及是否要回滚，基于 httpcode, load avg, 错误，响应等指标, 同时提供一些金丝雀质量的分析。</p><p><img src="https://cdn-images-1.medium.com/max/1600/1*WO9BwxGmMPrbcpVo4IyJ4Q.png"><br><img src="https://cdn-images-1.medium.com/max/1600/1*h65C2z-BmqQBIvcTQA0nag.png"></p><p>相关文章：</p><ul><li><a target="_blank" rel="noopener" href="https://www.infoq.com/news/2018/04/kayenta">https://www.infoq.com/news/2018/04/kayenta</a></li><li><a target="_blank" rel="noopener" href="https://medium.com/netflix-techblog/automated-canary-analysis-at-netflix-with-kayenta-3260bc7acc69">https://medium.com/netflix-techblog/automated-canary-analysis-at-netflix-with-kayenta-3260bc7acc69</a></li><li>一篇中文的分析和介绍 <a target="_blank" rel="noopener" href="http://ju.outofmemory.cn/entry/350839">http://ju.outofmemory.cn/entry/350839</a></li></ul><h2><span id="reference">Reference</span><a href="#reference" class="header-anchor"></a></h2><ul><li>这篇文章讲了各种常见的部署策略 <a target="_blank" rel="noopener" href="http://blog.itaysk.com/2017/11/20/deployment-strategies-defined">http://blog.itaysk.com/2017/11/20/deployment-strategies-defined</a></li><li>详细分析了各种部署策略和最佳实践 <a target="_blank" rel="noopener" href="https://rollbar.com/blog/deployment-strategies/">https://rollbar.com/blog/deployment-strategies/</a></li><li>比较全面的优势劣势对比 <a target="_blank" rel="noopener" href="http://www.10tiao.com/html/773/201803/2247487627/1.html">http://www.10tiao.com/html/773/201803/2247487627/1.html</a></li><li>Linkedln 应用实时线上流量进行自动化容量测量与性能瓶颈分析 slide <a target="_blank" rel="noopener" href="https://myslide.cn/slides/8824">https://myslide.cn/slides/8824</a></li></ul><h2><span id="guan-yu-tou-tu">关于头图</span><a href="#guan-yu-tou-tu" class="header-anchor"></a></h2><p>拍摄自水魔方</p><div class="post__prevs"><div class="post__prev"><a href="/2019/02/18/Run-sshd-in-Docker-container/" title="Run sshd in Docker container"><i class="iconfont icon-prev"></i>Run sshd in Docker container</a></div><div class="post__prev post__prev--right"><a href="/2019/02/28/2019-Feb-digest/" title="2019 年 2 月摘要">2019 年 2 月摘要<i class="iconfont icon-next"></i></a></div></div></div></article><div id="disqus_thread"></div></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">简介</h3><p class="block__text">Fledgling Developer | Backpacker | Doing all I can to be a better girl.</p></div><div class="sidebar__block"><h3 class="block__title">文章分类</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/tech/">tech</a><span class="block-list-count">20</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/reading/">reading</a><span class="block-list-count">6</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/music/">music</a><span class="block-list-count">8</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/life/">life</a><span class="block-list-count">38</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2023/08/31/2022-Oct-digest/" title="2022 年 10 月 ~ 2023 年 8 月"><div class="item__cover"><img src="https://github.com/AmyLewis/blog/assets/3325198/06d4024a-6a6e-4bf1-a3e4-575a1eba9389" alt="2022 年 10 月 ~ 2023 年 8 月"></div><div class="item__info"><h3 class="item__title">2022 年 10 月 ~ 2023 年 8 月</h3><span class="item__text">2023-08-31</span></div></a></li><li class="latest-post-item"><a href="/2022/09/30/2022-02-09-digest/" title="2022 年 2 ~ 9 月摘要"><div class="item__cover"><img src="https://user-images.githubusercontent.com/3325198/194582186-ee38f13c-5d74-42e4-b1c1-90045c865a09.jpeg" alt="2022 年 2 ~ 9 月摘要"></div><div class="item__info"><h3 class="item__title">2022 年 2 ~ 9 月摘要</h3><span class="item__text">2022-09-30</span></div></a></li><li class="latest-post-item"><a href="/2022/01/31/2021-12-digest/" title="2021 年 12 月 & 1 月摘要"><div class="item__cover"><img src="https://user-images.githubusercontent.com/3325198/152668876-eb16783b-8204-432e-9d98-17a9e5a9b510.jpeg" alt="2021 年 12 月 & 1 月摘要"></div><div class="item__info"><h3 class="item__title">2021 年 12 月 & 1 月摘要</h3><span class="item__text">2022-01-31</span></div></a></li><li class="latest-post-item"><a href="/2021/11/30/2021-11-digest/" title="2021 年 11 月摘要"><div class="item__cover"><img src="https://user-images.githubusercontent.com/3325198/145077778-da1bc9f0-d052-423e-a8a2-4128c1fe12ee.jpeg" alt="2021 年 11 月摘要"></div><div class="item__info"><h3 class="item__title">2021 年 11 月摘要</h3><span class="item__text">2021-11-30</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/algorithm/">algorithm</a></li><li class="tag-item"><a class="tag-link" href="/tags/code-reading/">code_reading</a></li><li class="tag-item"><a class="tag-link" href="/tags/cookbook/">cookbook</a></li><li class="tag-item"><a class="tag-link" href="/tags/digest/">digest</a></li><li class="tag-item"><a class="tag-link" href="/tags/life/">life</a></li><li class="tag-item"><a class="tag-link" href="/tags/music-log/">music_log</a></li><li class="tag-item"><a class="tag-link" href="/tags/reading/">reading</a></li><li class="tag-item"><a class="tag-link" href="/tags/tech/">tech</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%AE%9E%E9%AA%8C/">实验</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank">Skapp</a> 2018 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="https://github.com/Mrminfive" target="_blank">minfive</a>, modified by <a href="https://github.com/AmyLewis" target="_blank">amy</a></p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/AmyLewis" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:amylewis.private@gmail.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li><li class="social-network__item"><a href="/atom.xml" target="_blank" title="rss"><i class="iconfont icon-rss"></i></a></li></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script>var disqus_shortname="amylewis777",disqus_config=function(){this.page.url="http://amylewis.github.io/2019/02/25/Deploy-Strategy/",this.page.identifier="/2019/02/25/Deploy-Strategy/",this.page.title="Deploy Strategy"};!function(){var t=document,e=t.createElement("script");e.src="https://"+disqus_shortname+".disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></body></html>