<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><title>Twelve Factor App | Amyy Lewis</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="[object Object]"><meta name="designer" content="minfive"><meta name="keywords" content="life tech"><meta name="description" content="Fledgling Developer | Backpacker | Doing all I can to be a better girl."><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="http://amylewis.github.io/2018/11/24/twelve-factor-app/index.html"><link rel="icon" type="image/png" href="http://oo12ugek5.bkt.clouddn.com/blog/images/favicon.ico" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="AmyLewis" type="application/atom+xml"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-66043212-2"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-66043212-2")</script><link rel="stylesheet" href="/scss/views/page/post.css"><meta name="generator" content="Hexo 6.3.0"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(https://user-images.githubusercontent.com/3325198/52893052-6d1d2d80-31d3-11e9-91c2-736385c3278a.gif)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="AmyLewis" alt="AmyLewis"><img src="https://user-images.githubusercontent.com/3325198/52892707-fc284680-31cf-11e9-932d-e3cde3ef02f3.png" alt="AmyLewis"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/about" alt="关于" title="关于">关于</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="https://user-images.githubusercontent.com/3325198/52894285-081d0400-31e2-11e9-81bf-5e4ef827aebf.jpg" alt="Twelve Factor App"></div><header class="post__info"><h1 class="post__title">Twelve Factor App</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a target="_blank" rel="noopener" href="https://www.github.com/amylewis">amy</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2018-11-24</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/tech/">Tech</a></li></ul></div></div></header><div class="post__content"><p><strong>Table of content:</strong></p><div class="toc"><ul><li><a href="#about">About</a></li><li><a href="#zhun-ze">准则</a><ul><li><a href="#1-ji-zhun-dai-ma-yi-fen-ji-zhun-dai-ma-codebase-duo-fen-bu-shu-deploy">1. 基准代码, 一份基准代码（Codebase），多份部署（deploy）</a></li><li><a href="#2-yi-lai-xian-shi-sheng-ming-yi-lai-guan-xi-dependency">2. 依赖，显式声明依赖关系（ dependency ）</a></li><li><a href="#3-pei-zhi-dai-ma-he-pei-zhi-yan-ge-fen-chi">3. 配置, 代码和配置严格分离</a></li><li><a href="#4-hou-duan-fu-wu-ba-hou-duan-fu-wu-backing-services-dang-zuo-fu-jia-zi-yuan">4. 后端服务, 把后端服务(backing services)当作附加资源</a></li><li><a href="#5-gou-jian-fa-bu-yun-xing-yan-ge-fen-chi-gou-jian-he-yun-xing">5. 构建，发布，运行, 严格分离构建和运行</a></li><li><a href="#6-jin-cheng-yi-yi-ge-huo-duo-ge-wu-zhuang-tai-jin-cheng-yun-xing-ying-yong">6. 进程， 以一个或多个无状态进程运行应用</a></li><li><a href="#7-duan-kou-bang-ding-tong-guo-duan-kou-bang-ding-port-binding-lai-ti-gong-fu-wu">7. 端口绑定, 通过端口绑定(Port binding)来提供服务</a></li><li><a href="#8-bing-fa-tong-guo-jin-cheng-mo-xing-jin-xing-kuo-zhan">8. 并发, 通过进程模型进行扩展</a></li><li><a href="#9-yi-chu-li-kuai-su-qi-dong-he-you-ya-zhong-zhi-ke-zui-da-hua-jian-zhuang-xing">9. 易处理, 快速启动和优雅终止可最大化健壮性</a></li><li><a href="#10-kai-fa-huan-jing-yu-xian-shang-huan-jing-deng-jie-jin-ke-neng-de-bao-chi-kai-fa-yu-fa-bu-xian-shang-huan-jing-xiang-tong">10. 开发环境与线上环境等价, 尽可能的保持开发，预发布，线上环境相同</a></li></ul></li><li><a href="#reference">Reference</a></li><li><a href="#guan-yu-tou-tu">关于头图</a></li></ul></div><h3><span id="about">About</span><a href="#about" class="header-anchor"></a></h3><p><a target="_blank" rel="noopener" href="https://12factor.net/">https://12factor.net/</a> 是任何 SaaS 应用的开发人员, 部署和管理此类应用的运维工程师都应该阅读的准则。在很多技术书籍和官方文档上都有对其引用足以说明它的重要性。以下是主要是 12 factor 笔记，和自己在 PaaS 的开发中的一些理解。</p><h3><span id="zhun-ze">准则</span><a href="#zhun-ze" class="header-anchor"></a></h3><h4><span id="1-ji-zhun-dai-ma-yi-fen-ji-zhun-dai-ma-codebase-duo-fen-bu-shu-deploy">1. 基准代码, 一份基准代码（Codebase），多份部署（deploy）</span><a href="#1-ji-zhun-dai-ma-yi-fen-ji-zhun-dai-ma-codebase-duo-fen-bu-shu-deploy" class="header-anchor"></a></h4><p>多个应用共享一份基准代码是有悖于 12-Factor 原则的。共享的代码拆分为独立的类库，然后使用依赖管理策略去加载它们。</p><h4><span id="2-yi-lai-xian-shi-sheng-ming-yi-lai-guan-xi-dependency">2. 依赖，显式声明依赖关系（ dependency ）</span><a href="#2-yi-lai-xian-shi-sheng-ming-yi-lai-guan-xi-dependency" class="header-anchor"></a></h4><p>通过打包系统安装的类库可以是系统级的（称之为 「site packages」，或仅供某个应用程序使用，部署在相应的目录中（称之为 「vendoring」或 「bunding」）。</p><p>应用程序应该通过依赖清单，确切地声明所有依赖项和锁定对应的版本。此外，在各个环境运行过程中通过依赖隔离工具来确保程序不会调用系统中存在但清单中未声明的依赖项。</p><h4><span id="3-pei-zhi-dai-ma-he-pei-zhi-yan-ge-fen-chi">3. 配置, 代码和配置严格分离</span><a href="#3-pei-zhi-dai-ma-he-pei-zhi-yan-ge-fen-chi" class="header-anchor"></a></h4><p>在不同环境（如开发环境，金丝雀环境，生产环境）有很大差异的配置，如：</p><ul><li>一些资源连接串，如 MySQL， Redis，Beanstalk， 或者其他依赖的域名</li><li>第三方服务的证书</li></ul><p>代码和配置应该严格分离，并推荐放如环境变量中。环境变量可以非常方便地在不同的部署间做修改。</p><p>判断一个应用是否正确地将配置排除在代码之外，一个简单的方法是看该应用的基准代码是否可以立刻开源，而不用担心会暴露任何敏感的信息。</p><h4><span id="4-hou-duan-fu-wu-ba-hou-duan-fu-wu-backing-services-dang-zuo-fu-jia-zi-yuan">4. 后端服务, 把后端服务(backing services)当作附加资源</span><a href="#4-hou-duan-fu-wu-ba-hou-duan-fu-wu-backing-services-dang-zuo-fu-jia-zi-yuan" class="header-anchor"></a></h4><p>后端服务是指程序运行所需要的通过网络调用的各种服务，如数据库（MySQL，CouchDB），消息&#x2F;队列系统（RabbitMQ，Beanstalkd），SMTP 邮件发送服务（Postfix），Memcached， Redis 之类的。</p><p>也就是按照 3 的标准，这些后端服务都应该呈现为资源环境变量，要替换服务的时候只需要修改环境变量中的地址，不需要进行代码改动。</p><h4><span id="5-gou-jian-fa-bu-yun-xing-yan-ge-fen-chi-gou-jian-he-yun-xing">5. 构建，发布，运行, 严格分离构建和运行</span><a href="#5-gou-jian-fa-bu-yun-xing-yan-ge-fen-chi-gou-jian-he-yun-xing" class="header-anchor"></a></h4><p><img src="https://12factor.net/images/release.png"></p><p>基准代码 转化为一份部署(非开发环境)需要以下三个阶段：</p><ul><li>构建阶段 是指将代码仓库转化为可执行包的过程。构建时会使用指定版本的代码，获取和打包 依赖项，编译成二进制文件和资源文件。</li><li>发布阶段 会将构建的结果和当前部署所需 配置 相结合，并能够立刻在运行环境中投入使用。</li><li>运行阶段 （或者说“运行时”）是指针对选定的发布版本，在执行环境中启动一系列应用程序 进程。</li></ul><p>每一个发布版本必须对应一个唯一的发布 ID，例如可以使用发布时的时间戳（2011-04-06-20:32:17），亦或是一个增长的数字（v100）。发布的版本就像一本只能追加的账本，一旦发布就不可修改，任何的变动都应该产生一个新的发布版本。</p><p>严格区分构建，发布，运行这三个步骤。举例来说，直接修改处于运行状态的代码是非常不可取的做法，因为这些修改很难再同步回构建步骤。</p><h4><span id="6-jin-cheng-yi-yi-ge-huo-duo-ge-wu-zhuang-tai-jin-cheng-yun-xing-ying-yong">6. 进程， 以一个或多个无状态进程运行应用</span><a href="#6-jin-cheng-yi-yi-ge-huo-duo-ge-wu-zhuang-tai-jin-cheng-yun-xing-ying-yong" class="header-anchor"></a></h4><p>运行环境中，应用程序通常是以一个和多个进程运行的。</p><p>应用的进程必须无状态且无共享。 任何需要持久化的数据都要存储在后端服务内，比如数据库。</p><h4><span id="7-duan-kou-bang-ding-tong-guo-duan-kou-bang-ding-port-binding-lai-ti-gong-fu-wu">7. 端口绑定, 通过端口绑定(Port binding)来提供服务</span><a href="#7-duan-kou-bang-ding-tong-guo-duan-kou-bang-ding-port-binding-lai-ti-gong-fu-wu" class="header-anchor"></a></h4><p>应用完全自我加载 而不依赖于任何网络服务器就可以创建一个面向网络的服务。互联网应用通过端口绑定来提供服务，并监听发送至该端口的请求。</p><p>本地环境中，开发人员通过类似 <a target="_blank" rel="noopener" href="http://localhost:5000/">http://localhost:5000/</a> 的地址来访问服务。在线上环境中，请求统一发送至公共域名而后路由至绑定了端口的网络进程。</p><h4><span id="8-bing-fa-tong-guo-jin-cheng-mo-xing-jin-xing-kuo-zhan">8. 并发, 通过进程模型进行扩展</span><a href="#8-bing-fa-tong-guo-jin-cheng-mo-xing-jin-xing-kuo-zhan" class="header-anchor"></a></h4><p>在 12-factor 应用中，进程是一等公民。12-Factor 应用的进程主要借鉴于 unix 守护进程模型 。开发人员可以运用这个模型去设计应用架构，将不同的工作分配给不同的 进程类型 。例如，HTTP 请求可以交给 web 进程来处理，而常驻的后台工作则交由 worker 进程负责。</p><h4><span id="9-yi-chu-li-kuai-su-qi-dong-he-you-ya-zhong-zhi-ke-zui-da-hua-jian-zhuang-xing">9. 易处理, 快速启动和优雅终止可最大化健壮性</span><a href="#9-yi-chu-li-kuai-su-qi-dong-he-you-ya-zhong-zhi-ke-zui-da-hua-jian-zhuang-xing" class="header-anchor"></a></h4><p>应用的进程是易处理（disposable）的，意思是说它们可以瞬间开启或停止。进程应当追求 最小启动时间 。 理想状态下，进程从敲下命令到真正启动并等待请求的时间应该只需很短的时间。更少的启动时间提供了更敏捷的 发布 以及扩展过程，此外还增加了健壮性，因为进程管理器可以在授权情形下容易的将进程搬到新的物理机器上。</p><p>进程 一旦接收 终止信号（SIGTERM） 就会优雅的终止 。就网络进程而言，优雅终止是指停止监听服务的端口，即拒绝所有新的请求，并继续执行当前已接收的请求，然后退出。此类型的进程所隐含的要求是HTTP请求大多都很短(不会超过几秒钟)，而在长时间轮询中，客户端在丢失连接后应该马上尝试重连。</p><p>对于 worker 进程来说，优雅终止是指将当前任务退回队列。例如，RabbitMQ 中，worker 可以发送一个NACK信号。 Beanstalkd 中，任务终止并退回队列会在worker断开时自动触发。有锁机制的系统诸如 Delayed Job 则需要确定释放了系统资源。此类型的进程所隐含的要求是，任务都应该 可重复执行 ， 这主要由将结果包装进事务或是使重复操作 幂等 来实现。</p><p>进程还应当在面对突然死亡时保持健壮，例如底层硬件故障。虽然这种情况比起优雅终止来说少之又少，但终究有可能发生。一种推荐的方式是使用一个健壮的后端队列，例如 Beanstalkd ，它可以在客户端断开或超时后自动退回任务。无论如何，12-Factor 应用都应该可以设计能够应对意外的、不优雅的终结。Crash-only design 将这种概念转化为 合乎逻辑的理论。</p><h4><span id="10-kai-fa-huan-jing-yu-xian-shang-huan-jing-deng-jie-jin-ke-neng-de-bao-chi-kai-fa-yu-fa-bu-xian-shang-huan-jing-xiang-tong">10. 开发环境与线上环境等价, 尽可能的保持开发，预发布，线上环境相同</span><a href="#10-kai-fa-huan-jing-yu-xian-shang-huan-jing-deng-jie-jin-ke-neng-de-bao-chi-kai-fa-yu-fa-bu-xian-shang-huan-jing-xiang-tong" class="header-anchor"></a></h4><p>要做到持续部署， 就必须缩小本地与线上差异，可以使用 docker 或者 Vagrant 这样的方案来让本地开发和发布环境更贴近。</p><p>在实际工作中，我们尝试了构建部署使用 docker，并提供基于 docker 的本地开发 cli 来尽可能缩小不同环境之间的差异。</p><h3><span id="reference">Reference</span><a href="#reference" class="header-anchor"></a></h3><ul><li>12 Factor <a target="_blank" rel="noopener" href="https://12factor.net/">https://12factor.net/</a>, <a target="_blank" rel="noopener" href="https://12factor.net/zh_cn/">https://12factor.net/zh_cn/</a></li></ul><h3><span id="guan-yu-tou-tu">关于头图</span><a href="#guan-yu-tou-tu" class="header-anchor"></a></h3><ul><li>拍摄自今日美术馆</li></ul><div class="post__prevs"><div class="post__prev"><a href="/2018/11/24/Docker-cookbook/" title="Docker Cookbook"><i class="iconfont icon-prev"></i>Docker Cookbook</a></div><div class="post__prev post__prev--right"><a href="/2018/12/09/2018-Nov-digest/" title="2018 年 11 月摘要">2018 年 11 月摘要<i class="iconfont icon-next"></i></a></div></div></div></article><div id="disqus_thread"></div></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">简介</h3><p class="block__text">Fledgling Developer | Backpacker | Doing all I can to be a better girl.</p></div><div class="sidebar__block"><h3 class="block__title">文章分类</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/tech/">tech</a><span class="block-list-count">20</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/reading/">reading</a><span class="block-list-count">6</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/music/">music</a><span class="block-list-count">8</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/life/">life</a><span class="block-list-count">38</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2023/08/31/2022-Oct-digest/" title="2022 年 10 月 ~ 2023 年 8 月"><div class="item__cover"><img src="https://amylewis.github.io/images/2023-08.jpeg" alt="2022 年 10 月 ~ 2023 年 8 月"></div><div class="item__info"><h3 class="item__title">2022 年 10 月 ~ 2023 年 8 月</h3><span class="item__text">2023-08-31</span></div></a></li><li class="latest-post-item"><a href="/2022/09/30/2022-02-09-digest/" title="2022 年 2 ~ 9 月摘要"><div class="item__cover"><img src="https://user-images.githubusercontent.com/3325198/194582186-ee38f13c-5d74-42e4-b1c1-90045c865a09.jpeg" alt="2022 年 2 ~ 9 月摘要"></div><div class="item__info"><h3 class="item__title">2022 年 2 ~ 9 月摘要</h3><span class="item__text">2022-09-30</span></div></a></li><li class="latest-post-item"><a href="/2022/01/31/2021-12-digest/" title="2021 年 12 月 & 1 月摘要"><div class="item__cover"><img src="https://user-images.githubusercontent.com/3325198/152668876-eb16783b-8204-432e-9d98-17a9e5a9b510.jpeg" alt="2021 年 12 月 & 1 月摘要"></div><div class="item__info"><h3 class="item__title">2021 年 12 月 & 1 月摘要</h3><span class="item__text">2022-01-31</span></div></a></li><li class="latest-post-item"><a href="/2021/11/30/2021-11-digest/" title="2021 年 11 月摘要"><div class="item__cover"><img src="https://user-images.githubusercontent.com/3325198/145077778-da1bc9f0-d052-423e-a8a2-4128c1fe12ee.jpeg" alt="2021 年 11 月摘要"></div><div class="item__info"><h3 class="item__title">2021 年 11 月摘要</h3><span class="item__text">2021-11-30</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/algorithm/">algorithm</a></li><li class="tag-item"><a class="tag-link" href="/tags/code-reading/">code_reading</a></li><li class="tag-item"><a class="tag-link" href="/tags/cookbook/">cookbook</a></li><li class="tag-item"><a class="tag-link" href="/tags/digest/">digest</a></li><li class="tag-item"><a class="tag-link" href="/tags/life/">life</a></li><li class="tag-item"><a class="tag-link" href="/tags/music-log/">music_log</a></li><li class="tag-item"><a class="tag-link" href="/tags/reading/">reading</a></li><li class="tag-item"><a class="tag-link" href="/tags/tech/">tech</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%AE%9E%E9%AA%8C/">实验</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank">Skapp</a> 2018 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="https://github.com/Mrminfive" target="_blank">minfive</a>, modified by <a href="https://github.com/AmyLewis" target="_blank">amy</a></p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/AmyLewis" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:amylewis.private@gmail.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li><li class="social-network__item"><a href="/atom.xml" target="_blank" title="rss"><i class="iconfont icon-rss"></i></a></li></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script>var disqus_shortname="amylewis777",disqus_config=function(){this.page.url="http://amylewis.github.io/2018/11/24/twelve-factor-app/",this.page.identifier="/2018/11/24/twelve-factor-app/",this.page.title="Twelve Factor App"};!function(){var t=document,e=t.createElement("script");e.src="https://"+disqus_shortname+".disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></body></html>