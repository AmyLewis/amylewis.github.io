<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><title>Redis RDB 持久化遇到的问题 | Amyy Lewis</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="[object Object]"><meta name="designer" content="minfive"><meta name="keywords" content="life tech"><meta name="description" content="Fledgling Developer | Backpacker | Doing all I can to be a better girl."><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="http://amylewis.github.io/2018/09/03/Redis-RDB-%E6%8C%81%E4%B9%85%E5%8C%96%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/index.html"><link rel="icon" type="image/png" href="http://oo12ugek5.bkt.clouddn.com/blog/images/favicon.ico" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="AmyLewis" type="application/atom+xml"><script async src="https://www.googletagmanager.com/gtag/js?id=UA-66043212-2"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-66043212-2")</script><link rel="stylesheet" href="/scss/views/page/post.css"><meta name="generator" content="Hexo 6.3.0"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(https://user-images.githubusercontent.com/3325198/52893052-6d1d2d80-31d3-11e9-91c2-736385c3278a.gif)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="AmyLewis" alt="AmyLewis"><img src="https://user-images.githubusercontent.com/3325198/52892707-fc284680-31cf-11e9-932d-e3cde3ef02f3.png" alt="AmyLewis"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/about" alt="关于" title="关于">关于</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="https://user-images.githubusercontent.com/3325198/52894610-351fe580-31e7-11e9-9708-cd73773569b6.jpg" alt="Redis RDB 持久化遇到的问题"></div><header class="post__info"><h1 class="post__title">Redis RDB 持久化遇到的问题</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a target="_blank" rel="noopener" href="https://www.github.com/amylewis">amy</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2018-09-03</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/tech/">Tech</a></li><li class="mark__item"><a href="/tags/%E5%AE%9E%E9%AA%8C/">实验</a></li></ul></div></div></header><div class="post__content"><p><strong>Table of content:</strong></p><div class="toc"><ul><li><a href="#reference-he-tui-jian-yue-du">Reference 和推荐阅读</a></li><li><a href="#wen-ti-de-bei-jing">问题的背景</a></li><li><a href="#redis-chi-jiu-hua">Redis 持久化</a><ul><li><a href="#rdb-kuai-zhao">RDB 快照</a><ul><li><a href="#sava">SAVA</a></li><li><a href="#bgsave">BGSAVE</a></li></ul></li><li><a href="#aof-append-only-file">AOF（Append Only File）</a></li><li><a href="#liang-zhe-zen-me-xuan-ze">两者怎么选择 ？</a></li></ul></li><li><a href="#hui-dao-wen-ti-de-jie-jue-fang-an">回到问题的解决方案</a></li><li><a href="#guan-yu-tou-tu">关于头图</a></li></ul></div><br><h2><span id="reference-he-tui-jian-yue-du">Reference 和推荐阅读</span><a href="#reference-he-tui-jian-yue-du" class="header-anchor"></a></h2><ul><li>书籍「Redis 设计与实现」</li><li>Redis 作者对 Redis 持久化和其他常见数据库持久化之间的异同 <a target="_blank" rel="noopener" href="http://oldblog.antirez.com/post/redispersistence-demystified.html">blog</a></li><li>Redis 官方文档里面对 RDB 和 AOF 的介绍以及推荐的使用方式 <a target="_blank" rel="noopener" href="https://redis.io/topics/persistence">https://redis.io/topics/persistence</a></li><li><a target="_blank" rel="noopener" href="https://redis.io/topics/faq#background-saving-fails-with-a-fork-error-under-linux-even-if-i-have-a-lot-of-free-ram">Background saving fails with a fork() error under Linux even if I have a lot of free RAM!</a></li><li>Redis 内存使用优化和存储 <a target="_blank" rel="noopener" href="http://www.infoq.com/cn/articles/tq-redis-memory-usage-optimization-storage">http://www.infoq.com/cn/articles/tq-redis-memory-usage-optimization-storage</a></li></ul><h2><span id="wen-ti-de-bei-jing">问题的背景</span><a href="#wen-ti-de-bei-jing" class="header-anchor"></a></h2><p>一个部署在测试环境的服务容器数量突然掉成了 0 ，整个服务挂了，容器日志是这样的异常</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MISCONF Redis is configured to save RDB snapshots, but is currently not able to persist on disk. Commands that may modify the data set are disabled. Please check Redis logs for details about the error.</span><br></pre></td></tr></table></figure><p>上对应机器 <code>sudo tail /var/log/redis/redis-server.log -n 20</code> 看到的 Redis log</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">29348:M 31 Aug 00:24:35.060 # Can&#x27;t save in background: fork: Cannot allocate memory</span><br><span class="line">29348:M 31 Aug 00:24:41.067 * 1 changes in 900 seconds. Saving...</span><br><span class="line">29348:M 31 Aug 00:24:41.068 # Can&#x27;t save in background: fork: Cannot allocate memory</span><br><span class="line">29348:M 31 Aug 00:24:47.078 * 1 changes in 900 seconds. Saving...</span><br><span class="line">29348:M 31 Aug 00:24:47.078 # Can&#x27;t save in background: fork: Cannot allocate memory</span><br><span class="line">29348:M 31 Aug 00:24:53.090 * 1 changes in 900 seconds. Saving...</span><br><span class="line">29348:M 31 Aug 00:24:53.091 # Can&#x27;t save in background: fork: Cannot allocate memory</span><br><span class="line">29348:M 31 Aug 00:24:59.098 * 1 changes in 900 seconds. Saving...</span><br><span class="line">7145:M 26 Aug 06:26:42.787 * 10000 changes in 60 seconds. Saving...</span><br><span class="line">7145:M 26 Aug 06:26:42.788 * Background saving started by pid 8675</span><br><span class="line">8675:C 26 Aug 06:26:42.981 * DB saved on disk</span><br><span class="line">8675:C 26 Aug 06:26:42.983 * RDB: 6 MB of memory used by copy-on-write</span><br><span class="line">7145:M 26 Aug 06:26:42.988 * Background saving terminated with success</span><br></pre></td></tr></table></figure><p>看起来是 fork 进程时内存不足, 看到了 <a target="_blank" rel="noopener" href="https://gist.github.com/kapkaev/4619127">https://gist.github.com/kapkaev/4619127</a> 提供的解决方案, 更改 Redis 的 <code>stop-writes-on-bgsave-error</code> 的值, 在 Redis example 配置文件里面是这么描述这个配置项的:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">By default Redis will stop accepting writes if RDB snapshots are enabled</span><br><span class="line">(at least one save point) and the latest background save failed.</span><br><span class="line">This will make the user aware (in a hard way) that data is not persisting</span><br><span class="line">on disk properly, otherwise chances are that no one will notice and some</span><br><span class="line">disaster will happen.</span><br><span class="line"></span><br><span class="line">If the background saving process will start working again Redis will</span><br><span class="line">automatically allow writes again.</span><br><span class="line"></span><br><span class="line">However if you have setup your proper monitoring of the Redis server</span><br><span class="line">and persistence, you may want to disable this feature so that Redis will</span><br><span class="line">continue to work as usual even if there are problems with disk,</span><br><span class="line">permissions, and so forth.</span><br></pre></td></tr></table></figure><p><code>stop-writes-on-bgsave-error</code> 默认为 <code>yes</code>, 也就是如果 Redis 开启了 RDB 持久化并且最后一次失败了，Redis 默认会停止写入，让用户意识到数据的持久化没有正常工作。链接里面提供的解决方案是 <code>conf set stop-writes-on-bgsave-error</code> 设置为 no，只是让程序暂时忽略了这个问题，但是数据的持久化的问题并没有。但是 Redis 持久化相关的逻辑有哪些，这里持久化失败的原因是什么 ？</p><h2><span id="redis-chi-jiu-hua">Redis 持久化</span><a href="#redis-chi-jiu-hua" class="header-anchor"></a></h2><p>Redis 是内存数据库，它将数据库状态存储在内存里面，如果不想办法把存储在内存中的数据库状态保存到磁盘上，一旦服务器进程退出，服务器中的数据状态也会消失不见。为了解决这个问题，Redis 提供了集中持久化的方式：</p><ul><li>定时快照方式(snapshot)</li><li>基于语句追加文件的方式(aof)</li><li>虚拟内存(vm)</li><li>Diskstore 方式</li></ul><p>前两种是数据都在内存中，即小数据量下磁盘落地功能。后两种是存储数据超过物理内存时的方式。VM 本来是作为 Redis 存储超出物理内存数据的一种数据在内存与磁盘换入换出的一个持久化策略，但是其内存管理成本也非常的高, 目前已经处于被作者放弃的状态。而 diskstore 还在实验阶段。这本文主要提及前两种方式：</p><h3><span id="rdb-kuai-zhao">RDB 快照</span><a href="#rdb-kuai-zhao" class="header-anchor"></a></h3><p>RDB 的持久化既可以手动执行, 也可以根据服务器的配置定期自动执行。该功能可以将某个时间点上的数据库状态保存到一个 RDB 文件中。</p><p>RDB 文件是个经过压缩的二进制文件，通过该文件可以还原生成 RDB 文件时的数据库状态。因为 RDB 是保存在硬盘里面的，即使 Redis 进程退出，或者运行 Redis 的服务器停机，只要 RDB 文件依然存在，Redis 就可以用它来还原数据库状态。</p><p>有两个 Redis 命令可以用来生成 RDB 文件:</p><h4><span id="sava">SAVA</span><a href="#sava" class="header-anchor"></a></h4><p>SAVE 会阻塞 Redis 进程，直到 RDB 文件创建完成。在服务器进程阻塞期间，不能处理任何命令请求。</p><h4><span id="bgsave">BGSAVE</span><a href="#bgsave" class="header-anchor"></a></h4><p>BGSAVE 则会派生一个子进程，由子进程负责创建 RDB 文件，父进程继续处理命令请求。而执行 BGSAVE 期间，客户端发送的 BGSAVE 会被拒绝，因为同时执行两个 BGSAVE 会产生竞态条件。</p><h3><span id="aof-append-only-file">AOF（Append Only File）</span><a href="#aof-append-only-file" class="header-anchor"></a></h3><p>AOF 是通过保存所执行的写命令, 如 SET, SADD, RPUSH 来记录数据库状态。被写入 AOF 文件的所有命令都是以 Redis 的命令请求协议格式保存的，因为 Redis 的命令请求协议是纯文本格式。</p><p>AOF 持久化的实现分为：</p><ul><li>命令追加（append）</li><li>文件写入</li><li>文件同步（sync）</li></ul><p>当 AOF 持久化功能处于打开时，服务器在执行完一个写命令之后，会以协议的格式将被执行的写命令追加到服务器状态的 aof_buf 缓冲区的末尾。Redis 有对应的进程来确定是否要将 aof_buf 的内容写入和保存到 AOF 文件里面。</p><h3><span id="liang-zhe-zen-me-xuan-ze">两者怎么选择 ？</span><a href="#liang-zhe-zen-me-xuan-ze" class="header-anchor"></a></h3><p>通常 AOF 文件的更新频率比 RDB 的更高，所以</p><ul><li>如果服务器开启了 AOF，会优先使用 AOF 文件来还原数据库状态</li><li>只有在 AOF 持久化处于关闭状态时，服务器才会使用 RDB 文件来还原数据库状态</li></ul><p>在 Redis <a target="_blank" rel="noopener" href="https://redis.io/topics/persistence">官方文档</a> 里, 关于 AOF 和 RDB 的选择，提到了几点：</p><ul><li>如果想要更好的数据安全保障，推荐两者都使用</li><li>如果可以忍受几分钟的数据丢失， 只用 RDB 是没有问题的</li><li>不太建议只开启 AOF 模式，因为 RDB snapshot 这样按照时间持久化的是个很不错的方式，同时可以让重启更快。</li></ul><h2><span id="hui-dao-wen-ti-de-jie-jue-fang-an">回到问题的解决方案</span><a href="#hui-dao-wen-ti-de-jie-jue-fang-an" class="header-anchor"></a></h2><p>在当时 Redis 报内存不足时，对应机器上其实还剩余很多内存的。官方文档里面也提到这个话题 <a target="_blank" rel="noopener" href="https://redis.io/topics/faq#background-saving-fails-with-a-fork-error-under-linux-even-if-i-have-a-lot-of-free-ram">Background saving fails with a fork() error under Linux even if I have a lot of free RAM!</a></p><ol><li><p>修改内核参数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /proc/sys/vm/overcommit_memory</span><br></pre></td></tr></table></figure><p>Linux内核会根据参数 vm.overcommit_memory 参数的设置决定是否放行。</p></li><li><p>如果 vm.overcommit_memory &#x3D; 1，直接放行</p></li><li><p>vm.overcommit_memory &#x3D; 0：则比较此次请求分配的虚拟内存大小和系统当前空闲的物理内存加上 swap，决定是否放行。</p></li><li><p>vm.overcommit_memory &#x3D; 2：则会比较进程所有已分配的虚拟内存加上此次请求分配的虚拟内存和系统当前的空闲物理内存加上 swap，决定是否放行。</p></li><li><p>更改回 Redis 配置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conf stop-writes-on-bgsave-error yes</span><br></pre></td></tr></table></figure></li></ol><h2><span id="guan-yu-tou-tu">关于头图</span><a href="#guan-yu-tou-tu" class="header-anchor"></a></h2><ul><li>头图拍摄自迪拜 Mall, 天花板</li></ul><div class="post__prevs"><div class="post__prev"><a href="/2018/08/16/beanstalk-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/" title="beanstalk 生命周期"><i class="iconfont icon-prev"></i>beanstalk 生命周期</a></div><div class="post__prev post__prev--right"><a href="/2018/09/03/AHA-%E6%80%A5%E6%95%91%E8%AF%BE%E7%A8%8B/" title="AHA Heartsaver 急救课程记录">AHA Heartsaver 急救课程记录<i class="iconfont icon-next"></i></a></div></div></div></article><div id="disqus_thread"></div></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">简介</h3><p class="block__text">Fledgling Developer | Backpacker | Doing all I can to be a better girl.</p></div><div class="sidebar__block"><h3 class="block__title">文章分类</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/tech/">tech</a><span class="block-list-count">20</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/reading/">reading</a><span class="block-list-count">6</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/music/">music</a><span class="block-list-count">8</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/life/">life</a><span class="block-list-count">38</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2023/08/31/2022-Oct-digest/" title="2022 年 10 月 ~ 2023 年 8 月"><div class="item__cover"><img src="https://amylewis.github.io/images/2023-08.jpeg" alt="2022 年 10 月 ~ 2023 年 8 月"></div><div class="item__info"><h3 class="item__title">2022 年 10 月 ~ 2023 年 8 月</h3><span class="item__text">2023-08-31</span></div></a></li><li class="latest-post-item"><a href="/2022/09/30/2022-02-09-digest/" title="2022 年 2 ~ 9 月摘要"><div class="item__cover"><img src="https://user-images.githubusercontent.com/3325198/194582186-ee38f13c-5d74-42e4-b1c1-90045c865a09.jpeg" alt="2022 年 2 ~ 9 月摘要"></div><div class="item__info"><h3 class="item__title">2022 年 2 ~ 9 月摘要</h3><span class="item__text">2022-09-30</span></div></a></li><li class="latest-post-item"><a href="/2022/01/31/2021-12-digest/" title="2021 年 12 月 & 1 月摘要"><div class="item__cover"><img src="https://user-images.githubusercontent.com/3325198/152668876-eb16783b-8204-432e-9d98-17a9e5a9b510.jpeg" alt="2021 年 12 月 & 1 月摘要"></div><div class="item__info"><h3 class="item__title">2021 年 12 月 & 1 月摘要</h3><span class="item__text">2022-01-31</span></div></a></li><li class="latest-post-item"><a href="/2021/11/30/2021-11-digest/" title="2021 年 11 月摘要"><div class="item__cover"><img src="https://user-images.githubusercontent.com/3325198/145077778-da1bc9f0-d052-423e-a8a2-4128c1fe12ee.jpeg" alt="2021 年 11 月摘要"></div><div class="item__info"><h3 class="item__title">2021 年 11 月摘要</h3><span class="item__text">2021-11-30</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/algorithm/">algorithm</a></li><li class="tag-item"><a class="tag-link" href="/tags/code-reading/">code_reading</a></li><li class="tag-item"><a class="tag-link" href="/tags/cookbook/">cookbook</a></li><li class="tag-item"><a class="tag-link" href="/tags/digest/">digest</a></li><li class="tag-item"><a class="tag-link" href="/tags/life/">life</a></li><li class="tag-item"><a class="tag-link" href="/tags/music-log/">music_log</a></li><li class="tag-item"><a class="tag-link" href="/tags/reading/">reading</a></li><li class="tag-item"><a class="tag-link" href="/tags/tech/">tech</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%AE%9E%E9%AA%8C/">实验</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank">Skapp</a> 2018 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="https://github.com/Mrminfive" target="_blank">minfive</a>, modified by <a href="https://github.com/AmyLewis" target="_blank">amy</a></p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/AmyLewis" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:amylewis.private@gmail.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li><li class="social-network__item"><a href="/atom.xml" target="_blank" title="rss"><i class="iconfont icon-rss"></i></a></li></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script>var disqus_shortname="amylewis777",disqus_config=function(){this.page.url="http://amylewis.github.io/2018/09/03/Redis-RDB-持久化遇到的问题/",this.page.identifier="/2018/09/03/Redis-RDB-持久化遇到的问题/",this.page.title="Redis RDB 持久化遇到的问题"};!function(){var e=document,t=e.createElement("script");t.src="https://"+disqus_shortname+".disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)}()</script><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></body></html>